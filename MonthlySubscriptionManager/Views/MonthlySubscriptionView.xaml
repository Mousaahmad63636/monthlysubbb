<UserControl x:Class="QuickTechSystems.WPF.Views.MonthlySubscriptionView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:converters="clr-namespace:QuickTechSystems.WPF.Converters"
             mc:Ignorable="d">

    <UserControl.Resources>
        <converters:DecimalConverter x:Key="DecimalConverter"/>
        <converters:EqualityConverter x:Key="EqualityConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </UserControl.Resources>

    <!-- Main Grid with smaller margins -->
    <Grid Margin="10">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="0.45*" MinWidth="300"/>
            <ColumnDefinition Width="0.55*" MinWidth="350"/>
        </Grid.ColumnDefinitions>

        <!-- Left Side - Customer List -->
        <Grid Grid.Column="0" Margin="0,0,10,0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <TextBlock Text="Monthly Subscriptions"
                       FontSize="20"
                       FontWeight="Bold"
                       Foreground="{StaticResource PrimaryColor}"
                       Margin="0,0,0,10"/>

            <!-- Search Box -->
            <Grid Grid.Row="1" Margin="0,0,0,10">
                <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         Style="{StaticResource ModernSearchBox}"/>
                <TextBlock IsHitTestVisible="False"
                           Text="Search customers..."
                           VerticalAlignment="Center"
                           HorizontalAlignment="Left"
                           Margin="10,0,0,0"
                           Foreground="Gray">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SearchText}" Value="">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </Grid>

            <!-- Customers DataGrid -->
            <DataGrid Grid.Row="2"
                      ItemsSource="{Binding Customers}"
                      SelectedItem="{Binding SelectedCustomer}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      Style="{StaticResource ModernDataGridStyle}"
                      HorizontalScrollBarVisibility="Auto"
                      LoadingRow="DataGrid_LoadingRow">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Name" 
                                        Binding="{Binding Name}"
                                        Width="2*"/>
                    <DataGridTextColumn Header="Phone" 
                                        Binding="{Binding PhoneNumber}"
                                        Width="*"/>
                    <DataGridTextColumn Header="Last Reading" 
                                        Binding="{Binding NewCounter, StringFormat=N2}"
                                        Width="*"/>
                    <DataGridTextColumn Header="Bill" 
                                        Binding="{Binding TotalBillWithCharges, StringFormat=C2}"
                                        Width="*"/>
                    <DataGridTextColumn Header="Date" 
                                        Binding="{Binding LastBillDate, StringFormat=d}"
                                        Width="*"/>
                </DataGrid.Columns>
            </DataGrid>
        </Grid>

        <!-- Right Side Content -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Action Buttons -->
            <WrapPanel Grid.Row="0" 
                      Orientation="Horizontal" 
                      Margin="0,0,0,10">
                <Button Content="Add New Customer"
                        Command="{Binding AddCommand}"
                        Style="{StaticResource ActionButton}"
                        Margin="0,0,5,5"/>
                <Button Content="Export History"
                        Command="{Binding ExportHistoryCommand}"
                        Style="{StaticResource ActionButton}"
                        Margin="0,0,5,5"/>
            </WrapPanel>

            <!-- Monthly Statistics Section -->
            <GroupBox Grid.Row="1" 
                      Header="Monthly Statistics" 
                      Margin="0,0,0,10">
                <Grid Margin="5">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Period Selection -->
                    <WrapPanel Grid.Row="0" 
                               Orientation="Horizontal" 
                               Margin="0,0,0,10">
                        <StackPanel Orientation="Horizontal" 
                                    Margin="0,0,5,5">
                            <TextBlock Text="Year: " 
                                       VerticalAlignment="Center"
                                       Margin="0,0,5,0"/>
                            <ComboBox ItemsSource="{Binding AvailableYears}"
                                      SelectedItem="{Binding SelectedYear}"
                                      Width="80"/>
                        </StackPanel>
                        <Button Content="Print Receipts"
                                Command="{Binding PrintAllReceiptsCommand}"
                                Style="{StaticResource ActionButton}"
                                Margin="0,0,5,5"/>
                        <StackPanel Orientation="Horizontal"
                                    Margin="0,0,5,5">
                            <TextBlock Text="Month: " 
                                       VerticalAlignment="Center"
                                       Margin="0,0,5,0"/>
                            <ComboBox Width="95"
                                      SelectedValue="{Binding SelectedMonth}"
                                      SelectedValuePath="Tag">
                                <ComboBoxItem Content="January" Tag="1" IsSelected="{Binding SelectedMonth, Converter={StaticResource EqualityConverter}, ConverterParameter=1}"/>
                                <ComboBoxItem Content="February" Tag="2" IsSelected="{Binding SelectedMonth, Converter={StaticResource EqualityConverter}, ConverterParameter=2}"/>
                                <ComboBoxItem Content="March" Tag="3" IsSelected="{Binding SelectedMonth, Converter={StaticResource EqualityConverter}, ConverterParameter=3}"/>
                                <ComboBoxItem Content="April" Tag="4" IsSelected="{Binding SelectedMonth, Converter={StaticResource EqualityConverter}, ConverterParameter=4}"/>
                                <ComboBoxItem Content="May" Tag="5" IsSelected="{Binding SelectedMonth, Converter={StaticResource EqualityConverter}, ConverterParameter=5}"/>
                                <ComboBoxItem Content="June" Tag="6" IsSelected="{Binding SelectedMonth, Converter={StaticResource EqualityConverter}, ConverterParameter=6}"/>
                                <ComboBoxItem Content="July" Tag="7" IsSelected="{Binding SelectedMonth, Converter={StaticResource EqualityConverter}, ConverterParameter=7}"/>
                                <ComboBoxItem Content="August" Tag="8" IsSelected="{Binding SelectedMonth, Converter={StaticResource EqualityConverter}, ConverterParameter=8}"/>
                                <ComboBoxItem Content="September" Tag="9" IsSelected="{Binding SelectedMonth, Converter={StaticResource EqualityConverter}, ConverterParameter=9}"/>
                                <ComboBoxItem Content="October" Tag="10" IsSelected="{Binding SelectedMonth, Converter={StaticResource EqualityConverter}, ConverterParameter=10}"/>
                                <ComboBoxItem Content="November" Tag="11" IsSelected="{Binding SelectedMonth, Converter={StaticResource EqualityConverter}, ConverterParameter=11}"/>
                                <ComboBoxItem Content="December" Tag="12" IsSelected="{Binding SelectedMonth, Converter={StaticResource EqualityConverter}, ConverterParameter=12}"/>
                            </ComboBox>
                        </StackPanel>
                        <Button Content="Apply Filter"
                                Command="{Binding ApplyFilterCommand}"
                                Style="{StaticResource ActionButton}"
                                Margin="0,0,5,5"/>
                    </WrapPanel>

                    <!-- Statistics Display -->
                    <UniformGrid Grid.Row="1" 
                                Rows="1"
                                Columns="4" 
                                Margin="0,0,0,5">
                        <Border Background="#f0f9ff" 
                                CornerRadius="8" 
                                Padding="8" 
                                Margin="2">
                            <StackPanel>
                                <TextBlock Text="Total Consumption" 
                                           FontWeight="SemiBold"/>
                                <TextBlock Text="{Binding TotalConsumption, StringFormat={}{0:N2} kW}"
                                           FontSize="16" 
                                           Foreground="#0369a1"/>
                            </StackPanel>
                        </Border>
                        <Border Background="#f0fdf4" 
                                CornerRadius="8" 
                                Padding="8" 
                                Margin="2">
                            <StackPanel>
                                <TextBlock Text="Total Income" 
                                           FontWeight="SemiBold"/>
                                <TextBlock Text="{Binding TotalIncome, StringFormat={}{0:C2}}"
                                           FontSize="16" 
                                           Foreground="#166534"/>
                            </StackPanel>
                        </Border>
                        <Border Background="#fef2f2" 
                                CornerRadius="8" 
                                Padding="8" 
                                Margin="2">
                            <StackPanel>
                                <TextBlock Text="Total Expenses" 
                                           FontWeight="SemiBold"/>
                                <TextBlock Text="{Binding TotalExpenses, StringFormat={}{0:C2}}"
                                           FontSize="16" 
                                           Foreground="#991b1b"/>
                            </StackPanel>
                        </Border>
                        <Border Background="#f0fdfa" 
                                CornerRadius="8" 
                                Padding="8" 
                                Margin="2">
                            <StackPanel>
                                <TextBlock Text="Total Revenue" 
                                           FontWeight="SemiBold"/>
                                <TextBlock Text="{Binding TotalRevenue, StringFormat={}{0:C2}}"
                                           FontSize="16" 
                                           Foreground="#0f766e"/>
                            </StackPanel>
                        </Border>
                    </UniformGrid>
                </Grid>
            </GroupBox>

            <!-- Tabs Section -->
            <TabControl Grid.Row="2">
                <!-- Meter Reading Tab -->
                <TabItem Header="Meter Reading">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="8">
                            <!-- Reading Date Section -->
                            <Grid Margin="0,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Reading Date:" 
                                   FontWeight="SemiBold" 
                                   VerticalAlignment="Center"
                                   Margin="0,0,10,0"/>
                                <DatePicker Grid.Column="1" 
                                    SelectedDate="{Binding MeterReadingDate}"
                                    VerticalAlignment="Center"
                                    HorizontalAlignment="Left"
                                    Width="200"/>
                            </Grid>

                            <!-- Customer Info -->
                            <TextBlock Text="{Binding SelectedCustomer.Name}"
                               FontSize="18"
                               FontWeight="Bold"
                               Margin="0,0,0,8"/>

                            <!-- Meter Reading Section -->
                            <GroupBox Header="Meter Reading Details" Margin="0,0,0,10">
                                <Grid Margin="8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <!-- Previous Reading -->
                                    <StackPanel Grid.Column="0" Margin="0,0,5,0">
                                        <TextBlock Text="Previous Reading (kWh)"
                                           FontWeight="SemiBold"/>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBox Text="{Binding SelectedCustomer.OldCounter, StringFormat=N2, 
                                            UpdateSourceTrigger=PropertyChanged}"
                                            FontSize="14"
                                            Margin="0,5,5,5"/>
                                            <Button Grid.Column="1"
                                            Content="Update"
                                            Command="{Binding SaveCommand}"
                                            Style="{StaticResource ActionButton}"
                                            Width="70"
                                            Height="26"
                                            Margin="0,5,0,5"/>
                                        </Grid>
                                        <TextBlock Text="{Binding SelectedCustomer.LastBillDate, StringFormat='Date: {0:d}'}"
                                           Foreground="{StaticResource GrayTextColor}"
                                           FontSize="12"/>
                                    </StackPanel>

                                    <!-- Current Reading -->
                                    <StackPanel Grid.Column="1">
                                        <TextBlock Text="Current Reading (kWh)"
                                           FontWeight="SemiBold"/>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBox Text="{Binding NewReading, 
                                            UpdateSourceTrigger=PropertyChanged, 
                                            Converter={StaticResource DecimalConverter}}"
                                            FontSize="14"
                                            Margin="0,5,5,5"/>
                                            <Button Grid.Column="1"
                                            Content="Calculate"
                                            Command="{Binding CalculateCommand}"
                                            Style="{StaticResource ActionButton}"
                                            Width="70"
                                            Height="26"
                                            Margin="0,5,0,5"/>
                                        </Grid>
                                    </StackPanel>

                                    <!-- Consumption Summary -->
                                    <StackPanel Grid.Row="1" Grid.ColumnSpan="2" 
                                        Margin="0,10,0,0">
                                        <TextBlock Text="Consumption Summary"
                                           FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding Consumption, StringFormat='Usage: {0:N2} kWh'}"
                                           Margin="0,5"/>
                                        <TextBlock Text="{Binding UnitRate, StringFormat='Rate: {0:C2}/kWh'}"
                                           Margin="0,5"/>

                                        <!-- New input for additional fees with No Fees button -->
                                        <StackPanel Orientation="Horizontal" Margin="0,5">
                                            <TextBlock Text="Additional Fees:" 
                                               VerticalAlignment="Center"
                                               Margin="0,0,10,0"/>
                                            <TextBox Text="{Binding AdditionalFees, 
                                            UpdateSourceTrigger=PropertyChanged, 
                                            StringFormat=N2}"
                                             Width="100"
                                             PreviewTextInput="NumberValidationTextBox"
                                             Margin="0,0,5,0"/>
                                            <Button Content="No Fees" 
                                            Command="{Binding SetNoFeesCommand}"
                                            Style="{StaticResource ActionButton}"
                                            Padding="8,4"
                                            Height="25"/>
                                        </StackPanel>

                                        <TextBlock Text="{Binding BaseCharge, StringFormat='Base Charge: {0:C2}'}"
                                           Margin="0,5"/>
                                        <TextBlock Text="{Binding AdditionalCharge, StringFormat='Additional Charge: {0:C2}'}"
                                           Margin="0,5"/>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding TotalBill, StringFormat='Total Bill: {0:C2}'}" 
                                               FontSize="14" Margin="5"/>
                                            <TextBlock Text="{Binding TotalBillLBP, StringFormat=' ({0:N0} LBP)'}" 
                                               FontSize="14" Margin="5"/>
                                        </StackPanel>
                                    </StackPanel>

                                    <!-- Save Reading Button -->
                                    <Button Grid.Row="2" Grid.ColumnSpan="2"
                                    Content="Save Reading"
                                    Command="{Binding SaveReadingCommand}"
                                    Style="{StaticResource SuccessButton}"
                                    Margin="0,10,0,0"
                                    HorizontalAlignment="Right"
                                    Width="110"/>
                                </Grid>
                            </GroupBox>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>

                <!-- Customer Details Tab -->
                <TabItem Header="Details">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="8">
                            <Label Content="Name"/>
                            <TextBox Text="{Binding SelectedCustomer.Name, UpdateSourceTrigger=PropertyChanged}"
                                     IsEnabled="{Binding IsEditing}"/>

                            <Label Content="Phone Number"/>
                            <TextBox Text="{Binding SelectedCustomer.PhoneNumber, UpdateSourceTrigger=PropertyChanged}"
                                     IsEnabled="{Binding IsEditing}"/>

                            <Label Content="Subscription Type"/>
                            <ComboBox ItemsSource="{Binding SubscriptionTypes}"
                                      SelectedValue="{Binding SelectedCustomer.SubscriptionTypeId, NotifyOnSourceUpdated=True}"
                                      DisplayMemberPath="Name"
                                      SelectedValuePath="Id"
                                      IsEnabled="{Binding IsEditing}"
                                      Margin="0,0,0,8"/>

                            <Label Content="Price Per Unit ($)"/>
                            <TextBox Text="{Binding SelectedCustomer.PricePerUnit, StringFormat=N2, UpdateSourceTrigger=PropertyChanged}"
                                     IsEnabled="{Binding IsEditing}"/>
                            <TextBlock Text="Amount charged per unit (e.g., per kW/h)"
                                       Foreground="{StaticResource GrayTextColor}"
                                       FontSize="12"
                                       Margin="0,0,0,8"/>

                            <Label Content="Current Counter"/>
                            <TextBlock Text="{Binding SelectedCustomer.NewCounter, Mode=OneWay, StringFormat=N2}"
                                       Padding="5"/>

                            <Label Content="Base Bill Amount"/>
                            <TextBlock Text="{Binding SelectedCustomer.BillAmount, Mode=OneWay, StringFormat=C2}"
                                       Padding="5"/>

                            <Label Content="Additional Charges"/>
                            <TextBlock Text="{Binding SelectedCustomer.AdditionalCharge, Mode=OneWay, StringFormat=C2}"
                                       Padding="5"/>

                            <Label Content="Total Bill Amount"/>
                            <TextBlock Text="{Binding SelectedCustomer.TotalBillWithCharges, Mode=OneWay, StringFormat=C2}"
                                       FontWeight="Bold"
                                       Padding="5"/>

                            <Label Content="Last Bill Date"/>
                            <TextBlock Text="{Binding SelectedCustomer.LastBillDate, StringFormat=d}"
                                       Padding="5"/>

                            <!-- Action buttons -->
                            <StackPanel Orientation="Horizontal" 
                                        HorizontalAlignment="Right"
                                        Margin="0,15,0,0">
                                <Button Content="Save"
                                        Command="{Binding SaveCommand}"
                                        Style="{StaticResource SuccessButton}"
                                        Width="80"
                                        Margin="0,0,10,0"/>
                                <Button Content="Delete"
                                        Command="{Binding DeleteCommand}"
                                        Style="{StaticResource DangerButton}"
                                        Width="80"/>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>

                <!-- Counter History Tab -->
                <TabItem Header="History">
                    <DataGrid ItemsSource="{Binding CounterHistory}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              Style="{StaticResource ModernDataGridStyle}"
                              HorizontalScrollBarVisibility="Auto"
                              VerticalScrollBarVisibility="Auto">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Date" 
                                                Binding="{Binding RecordDate, StringFormat=d}"
                                                IsReadOnly="True"
                                                Width="90"/>
                            <DataGridTextColumn Header="Previous" 
                                                Binding="{Binding OldCounter, StringFormat=N2, UpdateSourceTrigger=PropertyChanged}"
                                                Width="85"/>
                            <DataGridTextColumn Header="New" 
                                                Binding="{Binding NewCounter, StringFormat=N2, UpdateSourceTrigger=PropertyChanged}"
                                                Width="85"/>
                            <DataGridTextColumn Header="Units" 
                                                Binding="{Binding UnitsUsed, StringFormat=N2}"
                                                IsReadOnly="True"
                                                Width="70"/>
                            <DataGridTextColumn Header="Price/Unit" 
                                                Binding="{Binding PricePerUnit, StringFormat=C2}"
                                                IsReadOnly="True"
                                                Width="85"/>
                            <DataGridTextColumn Header="Amount" 
                                                Binding="{Binding BillAmount, StringFormat=C2}"
                                                IsReadOnly="True"
                                                Width="85"/>
                            <DataGridTemplateColumn Width="240">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="Save"
                                                    Command="{Binding DataContext.SaveHistoryReadingCommand, 
                                                              RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    Style="{StaticResource ActionButton}"
                                                    Margin="0,0,3,0"
                                                    Padding="8,3"/>
                                            <Button Content="Print"
                                                    Command="{Binding DataContext.PrintReceiptCommand, 
                                                              RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    Style="{StaticResource ActionButton}"
                                                    Margin="0,0,3,0"
                                                    Padding="8,3"/>
                                            <Button Content="Delete"
                                                    Command="{Binding DataContext.DeleteHistoryReadingCommand, 
                                                              RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    Style="{StaticResource DangerButton}"
                                                    Padding="8,3"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </TabItem>

                <!-- Payments Tab -->
                <TabItem Header="Payments">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Month/Year Selection -->
                        <WrapPanel Grid.Row="0" Margin="5">
                            <StackPanel Orientation="Horizontal" 
                                      Margin="2,2,8,2">
                                <TextBlock Text="Year: " 
                                         VerticalAlignment="Center"
                                         Margin="0,0,5,0"/>
                                <ComboBox Width="80"
                                        ItemsSource="{Binding AvailableYears}"
                                        SelectedItem="{Binding SelectedYear}"/>
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" 
                                      Margin="2,2,8,2">
                                <TextBlock Text="Month: " 
                                         VerticalAlignment="Center"
                                         Margin="0,0,5,0"/>
                                <ComboBox Width="95"
                                        SelectedValue="{Binding SelectedMonth}"
                                        SelectedValuePath="Tag">
                                    <ComboBoxItem Content="January" Tag="1"/>
                                    <ComboBoxItem Content="February" Tag="2"/>
                                    <ComboBoxItem Content="March" Tag="3"/>
                                    <ComboBoxItem Content="April" Tag="4"/>
                                    <ComboBoxItem Content="May" Tag="5"/>
                                    <ComboBoxItem Content="June" Tag="6"/>
                                    <ComboBoxItem Content="July" Tag="7"/>
                                    <ComboBoxItem Content="August" Tag="8"/>
                                    <ComboBoxItem Content="September" Tag="9"/>
                                    <ComboBoxItem Content="October" Tag="10"/>
                                    <ComboBoxItem Content="November" Tag="11"/>
                                    <ComboBoxItem Content="December" Tag="12"/>
                                </ComboBox>
                            </StackPanel>
                        </WrapPanel>

                        <!-- Bill Summary -->
                        <Border Grid.Row="1" 
                                Background="#f8fafc"
                                CornerRadius="8"
                                Padding="10"
                                Margin="5">
                            <StackPanel>
                                <TextBlock Text="Monthly Bill Summary" 
                                           FontWeight="Bold"
                                           FontSize="16"
                                           Margin="0,0,0,5"/>

                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <StackPanel Grid.Column="0" Margin="2">
                                        <TextBlock Text="Total Bill"
                                                   FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding CurrentMonthBill, StringFormat=C2}"
                                                   FontSize="16"
                                                   Foreground="#0369a1"/>
                                    </StackPanel>

                                    <StackPanel Grid.Column="1" Margin="2">
                                        <TextBlock Text="Amount Paid"
                                                   FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding PaidAmount, StringFormat=C2}"
                                                   FontSize="16"
                                                   Foreground="#166534"/>
                                    </StackPanel>

                                    <StackPanel Grid.Column="2" Margin="2">
                                        <TextBlock Text="Remaining Balance"
                                                   FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding RemainingBalance, StringFormat=C2}"
                                                   FontSize="16"
                                                   Foreground="#991b1b"/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <!-- Payment Input -->
                        <StackPanel Grid.Row="2" Margin="5">
                            <Label Content="Payment Amount"/>
                            <TextBox Text="{Binding PaymentAmount, StringFormat=N2, UpdateSourceTrigger=PropertyChanged}"
                                     Margin="0,0,0,5"/>

                            <Label Content="Notes"/>
                            <TextBox Text="{Binding PaymentNotes, UpdateSourceTrigger=PropertyChanged}"
                                     Height="40"
                                     TextWrapping="Wrap"
                                     AcceptsReturn="True"
                                     Margin="0,0,0,5"/>

                            <Button Content="Process Payment"
                                    Command="{Binding ProcessPaymentCommand}"
                                    Style="{StaticResource SuccessButton}"
                                    HorizontalAlignment="Left"
                                    Width="120"/>
                        </StackPanel>

                        <!-- Payment History -->
                        <DataGrid Grid.Row="3"
                                  ItemsSource="{Binding PaymentHistory}"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  Style="{StaticResource ModernDataGridStyle}"
                                  HorizontalScrollBarVisibility="Auto"
                                  VerticalScrollBarVisibility="Auto"
                                  Margin="5"
                                  LoadingRow="DataGrid_LoadingRow">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Date" 
                                                    Binding="{Binding PaymentDate, StringFormat=d}"
                                                    Width="100"/>
                                <DataGridTextColumn Header="Amount" 
                                                    Binding="{Binding Amount, StringFormat=C2}"
                                                    Width="100"/>
                                <DataGridTextColumn Header="Notes" 
                                                    Binding="{Binding Notes}"
                                                    Width="*"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </TabItem>

                <!-- Settings Tab -->
                <TabItem Header="Settings">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="8">
                            <!-- Default Unit Price Section -->
                            <GroupBox Header="Default Unit Price" Margin="0,0,0,10">
                                <StackPanel Margin="8">
                                    <Label Content="Price per Unit ($)"/>
                                    <TextBox Text="{Binding DefaultUnitPrice, StringFormat=N2, UpdateSourceTrigger=PropertyChanged}"
                                             Margin="0,0,0,8"/>
                                    <Button Content="Save Default Price"
                                            Command="{Binding SaveSettingsCommand}"
                                            Style="{StaticResource SuccessButton}"
                                            HorizontalAlignment="Right"
                                            Width="120"/>
                                </StackPanel>
                            </GroupBox>

                            <!-- Subscription Types Section -->
                            <GroupBox Header="Subscription Types" Margin="0,0,0,10">
                                <StackPanel Margin="8">
                                    <Button Content="Add New Type"
                                            Command="{Binding AddSubscriptionTypeCommand}"
                                            Style="{StaticResource ActionButton}"
                                            HorizontalAlignment="Left"
                                            Margin="0,0,0,8"/>

                                    <DataGrid ItemsSource="{Binding SubscriptionTypes}"
                                              AutoGenerateColumns="False"
                                              IsReadOnly="True"
                                              Height="180"
                                              VerticalScrollBarVisibility="Auto"
                                              HorizontalScrollBarVisibility="Auto"
                                              LoadingRow="DataGrid_LoadingRow">
                                        <DataGrid.Columns>
                                            <DataGridTextColumn Header="Name" 
                                                                Binding="{Binding Name}"
                                                                Width="*"/>
                                            <DataGridTextColumn Header="Additional Charge" 
                                                                Binding="{Binding AdditionalCharge, StringFormat=C2}"
                                                                Width="120"/>
                                            <DataGridTextColumn Header="Customers" 
                                                                Binding="{Binding CustomerCount}"
                                                                Width="80"/>
                                        </DataGrid.Columns>
                                    </DataGrid>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>
            </TabControl>
        </Grid>

        <!-- Floating New Customer Form -->
        <Border Background="#80000000" 
                Visibility="{Binding IsNewCustomerDialogOpen, Converter={StaticResource BooleanToVisibilityConverter}}"
                Grid.ColumnSpan="2">
            <Border Background="White"
                    CornerRadius="10"
                    Width="380"
                    MaxHeight="500"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center"
                    Padding="15">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock Text="Add New Customer"
                                   FontSize="18"
                                   FontWeight="Bold"
                                   Margin="0,0,0,15"
                                   HorizontalAlignment="Center"/>

                        <Label Content="Name"/>
                        <TextBox Text="{Binding NewCustomer.Name, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="0,0,0,8"/>

                        <Label Content="Phone Number"/>
                        <TextBox Text="{Binding NewCustomer.PhoneNumber, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="0,0,0,8"/>

                        <Label Content="Subscription Type"/>
                        <ComboBox ItemsSource="{Binding SubscriptionTypes}"
                                  SelectedValue="{Binding NewCustomer.SubscriptionTypeId}"
                                  DisplayMemberPath="Name"
                                  SelectedValuePath="Id"
                                  Margin="0,0,0,8"/>

                        <Label Content="Price Per Unit ($)"/>
                        <TextBox Text="{Binding NewCustomer.PricePerUnit, StringFormat=N2, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="0,0,0,5"/>
                        <TextBlock Text="Leave empty to use default price"
                                   Foreground="{StaticResource GrayTextColor}"
                                   FontSize="12"
                                   Margin="0,0,0,8"/>

                        <Label Content="Initial Counter Reading"/>
                        <TextBox Text="{Binding NewCustomer.NewCounter, StringFormat=N2, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="0,0,0,15"/>

                        <StackPanel Orientation="Horizontal"
                                    HorizontalAlignment="Right">
                            <Button Content="Cancel"
                                    Command="{Binding CancelNewCustomerCommand}"
                                    Style="{StaticResource DangerButton}"
                                    Width="80"
                                    Margin="0,0,10,0"/>
                            <Button Content="Save"
                                    Command="{Binding SubmitNewCustomerCommand}"
                                    Style="{StaticResource SuccessButton}"
                                    Width="80"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Border>
    </Grid>
</UserControl>